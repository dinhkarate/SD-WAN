#===============================================================================
# VPS1 WireGuard Server Configuration (Method 2)
# File: /etc/wireguard/wg0.conf
# Nhận kết nối từ PC và forward đến VPS2 qua wg1
#
# ⚠️ POLICY ROUTING:
# - Traffic từ PC (10.0.0.0/24) → dùng table 51821 → đi qua wg1 → VPS2 → Internet
# - Traffic của VPS1 (SSH, updates) → dùng table main → trực tiếp Internet
#===============================================================================

[Interface]
# IP của VPS1 trong WireGuard network (tunnel 1 - với PC)
Address = 10.0.0.1/24

# Private key của wg0 (sẽ được tự động thay thế bởi setup.sh)
PrivateKey = <VPS1_WG0_PRIVATE_KEY>

# Port lắng nghe cho PC
ListenPort = 51820

# ===== IP Forward & Routing Rules =====
# Bật IP Forward
PostUp = sysctl -w net.ipv4.ip_forward=1

# Forward traffic từ wg0 (PC) sang wg1 (VPS2) và ngược lại
PostUp = iptables -A FORWARD -i wg0 -o wg1 -j ACCEPT
PostUp = iptables -A FORWARD -i wg1 -o wg0 -j ACCEPT

# NAT cho traffic từ PC khi đi qua wg1
PostUp = iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o wg1 -j MASQUERADE

# ===== POLICY ROUTING =====
# Route traffic từ PC (10.0.0.0/24) qua routing table 51821 (của wg1)
# Điều này đảm bảo:
#   - Traffic từ PC (10.0.0.x) → lookup table 51821 → đi qua wg1 → VPS2
#   - Traffic của VPS1 → lookup table main → đi trực tiếp Internet
PostUp = ip rule add from 10.0.0.0/24 lookup 51821 priority 100

PostDown = iptables -D FORWARD -i wg0 -o wg1 -j ACCEPT
PostDown = iptables -D FORWARD -i wg1 -o wg0 -j ACCEPT
PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o wg1 -j MASQUERADE
PostDown = ip rule del from 10.0.0.0/24 lookup 51821 priority 100

#===============================================================================
# PEER: PC Client
#===============================================================================
[Peer]
# Public key của PC (thay thế sau khi tạo key trên PC)
PublicKey = <PC_PUBLIC_KEY>

# IP được phép của PC trong tunnel
AllowedIPs = 10.0.0.2/32

# Giữ kết nối (không cần vì PC sẽ khởi tạo kết nối)
# PersistentKeepalive = 25
