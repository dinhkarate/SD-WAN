name: Deploy SD-WAN Method 2 (Double Tunnel)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Ch·ªçn h√†nh ƒë·ªông'
        required: true
        default: 'deploy-all'
        type: choice
        options:
          - deploy-all
          - restart-wireguard
          - check-status

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      vps1_host: ${{ steps.config.outputs.VPS1_HOST }}
      vps1_user: ${{ steps.config.outputs.VPS1_USER }}
      vps1_ssh_port: ${{ steps.config.outputs.VPS1_SSH_PORT }}
      vps2_host: ${{ steps.config.outputs.VPS2_HOST }}
      vps2_user: ${{ steps.config.outputs.VPS2_USER }}
      vps2_ssh_port: ${{ steps.config.outputs.VPS2_SSH_PORT }}
      wg_port: ${{ steps.config.outputs.WG_PORT }}
      wg_port_vps2: ${{ steps.config.outputs.WG_PORT_VPS2 }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration from config.env
        id: config
        run: |
          while IFS='=' read -r key value; do
            if [[ ! "$key" =~ ^# ]] && [[ -n "$key" ]]; then
              value=$(echo "$value" | tr -d '"')
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < config.env

  #=============================================================================
  # STEP 1: Deploy VPS2 (WireGuard Server + NAT)
  #=============================================================================
  deploy-vps2:
    needs: load-config
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    outputs:
      vps2_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy WireGuard config to VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üöÄ Deploying to VPS2: $VPS2_HOST"
          
          # T·∫°o th∆∞ m·ª•c
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "mkdir -p /root/sd-wan"
          
          # Copy files
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps2/setup.sh $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps2/wg0.conf $VPS2_USER@$VPS2_HOST:/etc/wireguard/wg0.conf
          
          # Ch·∫°y setup script
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS2 Public Key
        id: get-key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          VPS2_PUBLIC_KEY=$(ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "cat /etc/wireguard/vps2_publickey")
          echo "public_key=$VPS2_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS2 Public Key: $VPS2_PUBLIC_KEY"

  #=============================================================================
  # STEP 2: Deploy VPS1 (WireGuard Server + Client)
  #=============================================================================
  deploy-vps1:
    needs: [load-config, deploy-vps2]
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    outputs:
      vps1_wg0_public_key: ${{ steps.get-keys.outputs.wg0_public_key }}
      vps1_wg1_public_key: ${{ steps.get-keys.outputs.wg1_public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Prepare VPS1 configs
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2.outputs.vps2_public_key }}
          WG_PORT_VPS2: ${{ needs.load-config.outputs.wg_port_vps2 }}
        run: |
          # Thay th·∫ø VPS2_PUBLIC_IP trong wg1.conf
          sed -i "s|VPS2_PUBLIC_IP|$VPS2_HOST|g" method-2-double-tunnel/vps1/wg1.conf
          
          # Thay th·∫ø VPS2_PUBLIC_KEY trong wg1.conf
          sed -i "s|<VPS2_PUBLIC_KEY>|$VPS2_PUBLIC_KEY|g" method-2-double-tunnel/vps1/wg1.conf
          
          echo "‚úÖ ƒê√£ c·∫≠p nh·∫≠t wg1.conf v·ªõi VPS2 info"
          echo "   - VPS2 IP: $VPS2_HOST"
          echo "   - VPS2 Public Key: $VPS2_PUBLIC_KEY"

      - name: Deploy WireGuard configs to VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üöÄ Deploying to VPS1: $VPS1_HOST"
          
          # T·∫°o th∆∞ m·ª•c
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "mkdir -p /root/sd-wan"
          
          # Copy files
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/setup.sh $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/wg0.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/wg0.conf
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/wg1.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/wg1.conf
          
          # Ch·∫°y setup script
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS1 Public Keys
        id: get-keys
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          VPS1_WG0_PUBLIC_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_wg0_publickey")
          VPS1_WG1_PUBLIC_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_wg1_publickey")
          
          echo "wg0_public_key=$VPS1_WG0_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "wg1_public_key=$VPS1_WG1_PUBLIC_KEY" >> $GITHUB_OUTPUT
          
          echo "‚úÖ VPS1 wg0 Public Key (cho PC): $VPS1_WG0_PUBLIC_KEY"
          echo "‚úÖ VPS1 wg1 Public Key (cho VPS2): $VPS1_WG1_PUBLIC_KEY"

  #=============================================================================
  # STEP 3: Update VPS2 v·ªõi VPS1 wg1 Public Key
  #=============================================================================
  update-vps2-with-vps1-key:
    needs: [load-config, deploy-vps2, deploy-vps1]
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Update VPS2 with VPS1 wg1 Public Key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
          VPS1_WG1_PUBLIC_KEY: ${{ needs.deploy-vps1.outputs.vps1_wg1_public_key }}
        run: |
          echo "üîÑ Updating VPS2 with VPS1 wg1 Public Key..."
          echo "üîë VPS1 wg1 Public Key: $VPS1_WG1_PUBLIC_KEY"
          
          # Thay th·∫ø <VPS1_WG1_PUBLIC_KEY> trong wg0.conf c·ªßa VPS2
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "sed -i 's|<VPS1_WG1_PUBLIC_KEY>|$VPS1_WG1_PUBLIC_KEY|g' /etc/wireguard/wg0.conf"
          
          echo "‚úÖ VPS2 ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi VPS1 wg1 public key"

  #=============================================================================
  # STEP 4a: Restart WireGuard sau khi deploy (cho deploy-all)
  #=============================================================================
  restart-after-deploy:
    needs: [load-config, update-vps2-with-vps1-key]
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart WireGuard on VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS2..."
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0"
          echo "‚úÖ VPS2 WireGuard restarted"

      - name: Restart WireGuard on VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS1..."
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0 && wg-quick down wg1 2>/dev/null || true && wg-quick up wg1"
          echo "‚úÖ VPS1 WireGuard (wg0 + wg1) restarted"

  #=============================================================================
  # STEP 4b: Restart WireGuard ƒë·ªôc l·∫≠p (cho restart-wireguard action)
  #=============================================================================
  restart-wireguard:
    needs: [load-config]
    if: ${{ github.event.inputs.action == 'restart-wireguard' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart WireGuard on VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS2..."
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0"
          echo "‚úÖ VPS2 WireGuard restarted"

      - name: Restart WireGuard on VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS1..."
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0 && wg-quick down wg1 2>/dev/null || true && wg-quick up wg1"
          echo "‚úÖ VPS1 WireGuard (wg0 + wg1) restarted"

  #=============================================================================
  # STEP 5: Check Status
  #=============================================================================
  check-status:
    needs: [load-config]
    if: ${{ github.event.inputs.action == 'check-status' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check VPS1 Status
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS1 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "echo '--- wg0 (Server cho PC) ---' && wg show wg0 && echo '' && echo '--- wg1 (Client ƒë·∫øn VPS2) ---' && wg show wg1"

      - name: Check VPS2 Status
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS2 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg show"

      - name: Test Connectivity VPS1 to VPS2
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üîó Testing VPS1 ‚Üí VPS2 Connectivity"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "ping -c 3 10.0.1.1 && echo '‚úÖ VPS1 can reach VPS2 via WireGuard tunnel' || echo '‚ùå VPS1 cannot reach VPS2'"

  #=============================================================================
  # STEP 5b: Check Status sau deploy
  #=============================================================================
  check-status-after-deploy:
    needs: [load-config, restart-after-deploy]
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check VPS1 Status
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS1 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "echo '--- wg0 (Server cho PC) ---' && wg show wg0 && echo '' && echo '--- wg1 (Client ƒë·∫øn VPS2) ---' && wg show wg1"

      - name: Check VPS2 Status
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS2 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg show"

      - name: Test Connectivity VPS1 to VPS2
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üîó Testing VPS1 ‚Üí VPS2 Connectivity"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "ping -c 3 10.0.1.1 && echo '‚úÖ VPS1 can reach VPS2 via WireGuard tunnel' || echo '‚ùå VPS1 cannot reach VPS2'"

  #=============================================================================
  # STEP 6: Summary
  #=============================================================================
  summary:
    needs: [load-config, deploy-vps2, deploy-vps1, check-status-after-deploy]
    if: ${{ github.event.inputs.action == 'deploy-all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        env:
          VPS1_WG0_PUBLIC_KEY: ${{ needs.deploy-vps1.outputs.vps1_wg0_public_key }}
          VPS1_WG1_PUBLIC_KEY: ${{ needs.deploy-vps1.outputs.vps1_wg1_public_key }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2.outputs.vps2_public_key }}
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          WG_PORT: ${{ needs.load-config.outputs.wg_port }}
        run: |
          echo "================================================================"
          echo "  üìä DEPLOYMENT SUMMARY - METHOD 2 (Double Tunnel)"
          echo "================================================================"
          echo ""
          echo "‚úÖ VPS1 v√† VPS2 ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh v·ªõi chain WireGuard!"
          echo ""
          echo "üìç Network Topology:"
          echo "   PC (10.0.0.2) ‚îÄ‚îÄwg0‚îÄ‚îÄ> VPS1 (10.0.0.1/10.0.1.2) ‚îÄ‚îÄwg1‚îÄ‚îÄ> VPS2 (10.0.1.1) ‚îÄ‚îÄNAT‚îÄ‚îÄ> Internet"
          echo ""
          echo "üîë Public Keys:"
          echo "   - VPS1 wg0 (cho PC):  $VPS1_WG0_PUBLIC_KEY"
          echo "   - VPS1 wg1 (cho VPS2): $VPS1_WG1_PUBLIC_KEY"
          echo "   - VPS2:               $VPS2_PUBLIC_KEY"
          echo ""
          echo "================================================================"
          echo "  üìù C·∫§U H√åNH CHO PC (Windows WireGuard)"
          echo "================================================================"
          echo ""
          echo "[Interface]"
          echo "Address = 10.0.0.2/24"
          echo "PrivateKey = <PC_PRIVATE_KEY>"
          echo "DNS = 8.8.8.8"
          echo ""
          echo "[Peer]"
          echo "PublicKey = $VPS1_WG0_PUBLIC_KEY"
          echo "Endpoint = $VPS1_HOST:$WG_PORT"
          echo "AllowedIPs = 0.0.0.0/0"
          echo "PersistentKeepalive = 25"
          echo ""
          echo "================================================================"
          echo "  üìã B∆Ø·ªöC TI·∫æP THEO"
          echo "================================================================"
          echo ""
          echo "1. M·ªü WireGuard tr√™n Windows"
          echo "2. Add Tunnel ‚Üí Add empty tunnel"
          echo "3. Copy config ·ªü tr√™n (thay <PC_PRIVATE_KEY> b·∫±ng key t·ª± ƒë·ªông t·∫°o)"
          echo "4. L∆∞u l·∫°i PC Public Key hi·ªÉn th·ªã"
          echo "5. SSH v√†o VPS1 ƒë·ªÉ th√™m PC public key:"
          echo ""
          echo "   ssh root@$VPS1_HOST"
          echo "   sed -i 's|<PC_PUBLIC_KEY>|YOUR_PC_PUBLIC_KEY|g' /etc/wireguard/wg0.conf"
          echo "   wg-quick down wg0 && wg-quick up wg0"
          echo ""
          echo "6. B·∫≠t WireGuard tr√™n PC v√† test:"
          echo "   ping 10.0.0.1   (VPS1)"
          echo "   ping 10.0.1.1   (VPS2)"
          echo "   curl ifconfig.me  (ph·∫£i tr·∫£ v·ªÅ IP c·ªßa VPS2: $VPS2_HOST)"
          echo ""
          echo "================================================================"
