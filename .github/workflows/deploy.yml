name: Deploy SD-WAN to VPS

on:
  workflow_dispatch:
    inputs:
      method:
        description: 'Chá»n method triá»ƒn khai'
        required: true
        default: 'method-1'
        type: choice
        options:
          - method-1
          - method-2
      target:
        description: 'Chá»n VPS Ä‘á»ƒ deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - vps1
          - vps2
          - both

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      vps1_host: ${{ steps.config.outputs.VPS1_HOST }}
      vps1_user: ${{ steps.config.outputs.VPS1_USER }}
      vps1_ssh_port: ${{ steps.config.outputs.VPS1_SSH_PORT }}
      vps2_host: ${{ steps.config.outputs.VPS2_HOST }}
      vps2_user: ${{ steps.config.outputs.VPS2_USER }}
      vps2_ssh_port: ${{ steps.config.outputs.VPS2_SSH_PORT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration from config.env
        id: config
        run: |
          # Äá»c file config.env vÃ  export cÃ¡c biáº¿n
          while IFS='=' read -r key value; do
            # Bá» qua comment vÃ  dÃ²ng trá»‘ng
            if [[ ! "$key" =~ ^# ]] && [[ -n "$key" ]]; then
              # Loáº¡i bá» dáº¥u ngoáº·c kÃ©p
              value=$(echo "$value" | tr -d '"')
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < config.env

  deploy-vps1:
    needs: load-config
    if: ${{ github.event.inputs.target == 'vps1' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          echo "ðŸš€ Deploying to VPS1: $VPS1_HOST"
          echo "ðŸ“¦ Method: $METHOD"
          
          # XÃ¡c Ä‘á»‹nh thÆ° má»¥c method
          if [ "$METHOD" == "method-1" ]; then
            METHOD_DIR="method-1-single-tunnel"
          else
            METHOD_DIR="method-2-double-tunnel"
          fi
          
          # Táº¡o thÆ° má»¥c trÃªn VPS
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "mkdir -p /root/sd-wan"
          
          # Copy config.env
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          
          # Copy setup script
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps1/setup.sh $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          
          # Copy WireGuard configs náº¿u cÃ³
          if [ -f "$METHOD_DIR/vps1/wg0.conf" ]; then
            scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps1/wg0.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/ || true
          fi
          if [ -f "$METHOD_DIR/vps1/wg1.conf" ]; then
            scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps1/wg1.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/ || true
          fi
          
          # Cháº¡y setup script
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"
          
          echo "âœ… VPS1 deployment completed!"

  deploy-vps2:
    needs: load-config
    if: ${{ github.event.inputs.target == 'vps2' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          echo "ðŸš€ Deploying to VPS2: $VPS2_HOST"
          echo "ðŸ“¦ Method: $METHOD"
          
          # XÃ¡c Ä‘á»‹nh thÆ° má»¥c method
          if [ "$METHOD" == "method-1" ]; then
            METHOD_DIR="method-1-single-tunnel"
          else
            METHOD_DIR="method-2-double-tunnel"
          fi
          
          # Táº¡o thÆ° má»¥c trÃªn VPS
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "mkdir -p /root/sd-wan"
          
          # Copy config.env
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          
          # Copy setup script
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps2/setup.sh $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          
          # Copy WireGuard config
          if [ -f "$METHOD_DIR/vps2/wg0.conf" ]; then
            scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps2/wg0.conf $VPS2_USER@$VPS2_HOST:/etc/wireguard/
          fi
          
          # Cháº¡y setup script
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"
          
          echo "âœ… VPS2 deployment completed!"

  summary:
    needs: [deploy-vps1, deploy-vps2]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "================================================"
          echo "  ðŸ“Š DEPLOYMENT SUMMARY"
          echo "================================================"
          echo "Method: ${{ github.event.inputs.method }}"
          echo "Target: ${{ github.event.inputs.target }}"
          echo ""
          echo "VPS1 Status: ${{ needs.deploy-vps1.result }}"
          echo "VPS2 Status: ${{ needs.deploy-vps2.result }}"
          echo "================================================"
