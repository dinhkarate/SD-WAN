name: Deploy SD-WAN to VPS

on:
  workflow_dispatch:
    inputs:
      method:
        description: 'Ch·ªçn method tri·ªÉn khai'
        required: true
        default: 'method-1'
        type: choice
        options:
          - method-1

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      vps1_host: ${{ steps.config.outputs.VPS1_HOST }}
      vps1_user: ${{ steps.config.outputs.VPS1_USER }}
      vps1_ssh_port: ${{ steps.config.outputs.VPS1_SSH_PORT }}
      vps2_host: ${{ steps.config.outputs.VPS2_HOST }}
      vps2_user: ${{ steps.config.outputs.VPS2_USER }}
      vps2_ssh_port: ${{ steps.config.outputs.VPS2_SSH_PORT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration from config.env
        id: config
        run: |
          while IFS='=' read -r key value; do
            if [[ ! "$key" =~ ^# ]] && [[ -n "$key" ]]; then
              value=$(echo "$value" | tr -d '"')
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < config.env

  deploy-vps1:
    needs: load-config
    runs-on: ubuntu-latest
    outputs:
      vps1_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          echo "üöÄ Deploying to VPS1: $VPS1_HOST"
          
          if [ "$METHOD" == "method-1" ]; then
            METHOD_DIR="method-1-single-tunnel"
          else
            METHOD_DIR="method-2-double-tunnel"
          fi
          
          # T·∫°o th∆∞ m·ª•c v√† copy files
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps1/setup.sh $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          
          # Ch·∫°y setup script
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS1 Public Key
        id: get-key
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          VPS1_PUBLIC_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_publickey")
          echo "public_key=$VPS1_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS1 Public Key: $VPS1_PUBLIC_KEY"

  deploy-vps2:
    needs: [load-config, deploy-vps1]
    runs-on: ubuntu-latest
    outputs:
      vps2_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
          VPS1_PUBLIC_KEY: ${{ needs.deploy-vps1.outputs.vps1_public_key }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          echo "üöÄ Deploying to VPS2: $VPS2_HOST"
          echo "üîë Using VPS1 Public Key: $VPS1_PUBLIC_KEY"
          
          if [ "$METHOD" == "method-1" ]; then
            METHOD_DIR="method-1-single-tunnel"
          else
            METHOD_DIR="method-2-double-tunnel"
          fi
          
          # T·∫°o th∆∞ m·ª•c v√† copy files
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no $METHOD_DIR/vps2/setup.sh $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          
          # Ch·∫°y setup script v·ªõi VPS1 public key
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh '$VPS1_PUBLIC_KEY'"

      - name: Get VPS2 Public Key
        id: get-key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          VPS2_PUBLIC_KEY=$(ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "cat /etc/wireguard/vps2_publickey")
          echo "public_key=$VPS2_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS2 Public Key: $VPS2_PUBLIC_KEY"

  update-vps1-with-vps2-key:
    needs: [load-config, deploy-vps1, deploy-vps2]
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Update VPS1 with VPS2 Public Key
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2.outputs.vps2_public_key }}
        run: |
          echo "üîÑ Updating VPS1 with VPS2 Public Key..."
          echo "üîë VPS2 Public Key: $VPS2_PUBLIC_KEY"
          
          # Thay th·∫ø <VPS2_PUBLIC_KEY> trong wg0.conf c·ªßa VPS1
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "sed -i 's|<VPS2_PUBLIC_KEY>|$VPS2_PUBLIC_KEY|g' /etc/wireguard/wg0.conf"
          
          echo "‚úÖ VPS1 ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi VPS2 public key"

  summary:
    needs: [load-config, deploy-vps1, deploy-vps2, update-vps1-with-vps2-key]
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        env:
          VPS1_PUBLIC_KEY: ${{ needs.deploy-vps1.outputs.vps1_public_key }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2.outputs.vps2_public_key }}
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
        run: |
          echo "================================================"
          echo "  üìä DEPLOYMENT SUMMARY"
          echo "================================================"
          echo ""
          echo "‚úÖ VPS1 v√† VPS2 ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh!"
          echo ""
          echo "üîë VPS1 Public Key (d√πng cho PC config):"
          echo "================================================"
          echo "$VPS1_PUBLIC_KEY"
          echo "================================================"
          echo ""
          echo "üìù B∆∞·ªõc ti·∫øp theo cho PC:"
          echo "  1. M·ªü WireGuard tr√™n Windows"
          echo "  2. Add Tunnel ‚Üí Add empty tunnel"
          echo "  3. S·ª≠ d·ª•ng config sau:"
          echo ""
          echo "[Interface]"
          echo "Address = 10.0.0.2/24"
          echo "PrivateKey = <PC_PRIVATE_KEY>"
          echo "DNS = 8.8.8.8"
          echo ""
          echo "[Peer]"
          echo "PublicKey = $VPS1_PUBLIC_KEY"
          echo "Endpoint = $VPS1_HOST:51820"
          echo "AllowedIPs = 0.0.0.0/0"
          echo "PersistentKeepalive = 25"
          echo ""
          echo "  4. L·∫•y PC public key v√† th√™m v√†o VPS1:"
          echo "     ssh root@$VPS1_HOST"
          echo "     sed -i 's|<PC_PUBLIC_KEY>|YOUR_PC_PUBLIC_KEY|g' /etc/wireguard/wg0.conf"
          echo ""
          echo "  5. B·∫≠t WireGuard tr√™n c·∫£ 2 VPS:"
          echo "     VPS1: wg-quick up wg0"
          echo "     VPS2: wg-quick up wg0"
          echo ""
          echo "================================================"
