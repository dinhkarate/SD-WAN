name: Deploy SD-WAN to VPS

on:
  workflow_dispatch:
    inputs:
      method:
        description: 'Ch·ªçn method tri·ªÉn khai'
        required: true
        default: 'method-1'
        type: choice
        options:
          - method-1
          - method-2
      action:
        description: 'Ch·ªçn h√†nh ƒë·ªông'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - start-wireguard

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      vps1_host: ${{ steps.config.outputs.VPS1_HOST }}
      vps1_user: ${{ steps.config.outputs.VPS1_USER }}
      vps1_ssh_port: ${{ steps.config.outputs.VPS1_SSH_PORT }}
      vps2_host: ${{ steps.config.outputs.VPS2_HOST }}
      vps2_user: ${{ steps.config.outputs.VPS2_USER }}
      vps2_ssh_port: ${{ steps.config.outputs.VPS2_SSH_PORT }}
      wg_port: ${{ steps.config.outputs.WG_PORT }}
      wg_port_vps2: ${{ steps.config.outputs.WG_PORT_VPS2 }}
      pc_public_key: ${{ steps.config.outputs.PC_PUBLIC_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load configuration from config.env
        id: config
        run: |
          while IFS='=' read -r key value; do
            if [[ ! "$key" =~ ^# ]] && [[ -n "$key" ]]; then
              value=$(echo "$value" | tr -d '"')
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < config.env

  #=============================================================================
  # METHOD 1: VPS1 first, then VPS2
  #=============================================================================
  deploy-vps1-method1:
    needs: load-config
    if: ${{ github.event.inputs.method == 'method-1' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    outputs:
      vps1_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üöÄ [Method 1] Deploying to VPS1: $VPS1_HOST"
          
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-1-single-tunnel/vps1/setup.sh $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-1-single-tunnel/vps1/wg0.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/wg0.conf
          
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS1 Public Key
        id: get-key
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          VPS1_PUBLIC_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_publickey")
          echo "public_key=$VPS1_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS1 Public Key: $VPS1_PUBLIC_KEY"

  deploy-vps2-method1:
    needs: [load-config, deploy-vps1-method1]
    if: ${{ github.event.inputs.method == 'method-1' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    outputs:
      vps2_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Prepare VPS2 config with VPS1 info
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_PUBLIC_KEY: ${{ needs.deploy-vps1-method1.outputs.vps1_public_key }}
        run: |
          sed -i "s|VPS1_PUBLIC_IP|$VPS1_HOST|g" method-1-single-tunnel/vps2/wg0.conf
          sed -i "s|<VPS1_PUBLIC_KEY>|$VPS1_PUBLIC_KEY|g" method-1-single-tunnel/vps2/wg0.conf

      - name: Deploy to VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üöÄ [Method 1] Deploying to VPS2: $VPS2_HOST"
          
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-1-single-tunnel/vps2/setup.sh $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-1-single-tunnel/vps2/wg0.conf $VPS2_USER@$VPS2_HOST:/etc/wireguard/wg0.conf
          
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS2 Public Key
        id: get-key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          VPS2_PUBLIC_KEY=$(ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "cat /etc/wireguard/vps2_publickey")
          echo "public_key=$VPS2_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS2 Public Key: $VPS2_PUBLIC_KEY"

  update-vps1-method1:
    needs: [load-config, deploy-vps1-method1, deploy-vps2-method1]
    if: ${{ github.event.inputs.method == 'method-1' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Update VPS1 with VPS2 Public Key
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2-method1.outputs.vps2_public_key }}
        run: |
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "sed -i 's|<VPS2_PUBLIC_KEY>|$VPS2_PUBLIC_KEY|g' /etc/wireguard/wg0.conf"
          echo "‚úÖ VPS1 updated with VPS2 public key"

  #=============================================================================
  # METHOD 2: VPS2 first, then VPS1 (with wg0 + wg1)
  #=============================================================================
  deploy-vps2-method2:
    needs: load-config
    if: ${{ github.event.inputs.method == 'method-2' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    outputs:
      vps2_public_key: ${{ steps.get-key.outputs.public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üöÄ [Method 2] Deploying to VPS2 FIRST: $VPS2_HOST"
          
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps2/setup.sh $VPS2_USER@$VPS2_HOST:/root/sd-wan/
          scp -P $VPS2_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps2/wg1.conf $VPS2_USER@$VPS2_HOST:/etc/wireguard/wg1.conf
          
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS2 Public Key
        id: get-key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          VPS2_PUBLIC_KEY=$(ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "cat /etc/wireguard/vps2_publickey")
          echo "public_key=$VPS2_PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS2 Public Key: $VPS2_PUBLIC_KEY"

  deploy-vps1-method2:
    needs: [load-config, deploy-vps2-method2]
    if: ${{ github.event.inputs.method == 'method-2' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    outputs:
      vps1_wg0_public_key: ${{ steps.get-keys.outputs.wg0_public_key }}
      vps1_wg1_public_key: ${{ steps.get-keys.outputs.wg1_public_key }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Prepare VPS1 configs with VPS2 info and PC Public Key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_PUBLIC_KEY: ${{ needs.deploy-vps2-method2.outputs.vps2_public_key }}
          PC_PUBLIC_KEY: ${{ needs.load-config.outputs.pc_public_key }}
        run: |
          # Update wg1.conf with VPS2 info
          sed -i "s|VPS2_PUBLIC_IP|$VPS2_HOST|g" method-2-double-tunnel/vps1/wg1.conf
          sed -i "s|<VPS2_PUBLIC_KEY>|$VPS2_PUBLIC_KEY|g" method-2-double-tunnel/vps1/wg1.conf
          echo "‚úÖ Updated wg1.conf with VPS2 IP: $VPS2_HOST and Key: $VPS2_PUBLIC_KEY"
          
          # Update wg0.conf with PC Public Key
          sed -i "s|<PC_PUBLIC_KEY>|$PC_PUBLIC_KEY|g" method-2-double-tunnel/vps1/wg0.conf
          echo "‚úÖ Updated wg0.conf with PC Public Key: $PC_PUBLIC_KEY"

      - name: Deploy to VPS1 (wg0 + wg1)
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üöÄ [Method 2] Deploying to VPS1: $VPS1_HOST"
          
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "mkdir -p /root/sd-wan"
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no config.env $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/setup.sh $VPS1_USER@$VPS1_HOST:/root/sd-wan/
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/wg0.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/wg0.conf
          scp -P $VPS1_SSH_PORT -o StrictHostKeyChecking=no method-2-double-tunnel/vps1/wg1.conf $VPS1_USER@$VPS1_HOST:/etc/wireguard/wg1.conf
          
          ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "chmod +x /root/sd-wan/setup.sh && /root/sd-wan/setup.sh"

      - name: Get VPS1 Public Keys
        id: get-keys
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          VPS1_WG0_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_wg0_publickey")
          VPS1_WG1_KEY=$(ssh -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "cat /etc/wireguard/vps1_wg1_publickey")
          echo "wg0_public_key=$VPS1_WG0_KEY" >> $GITHUB_OUTPUT
          echo "wg1_public_key=$VPS1_WG1_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ VPS1 wg0 Key (for PC): $VPS1_WG0_KEY"
          echo "‚úÖ VPS1 wg1 Key (for VPS2): $VPS1_WG1_KEY"

  update-vps2-method2:
    needs: [load-config, deploy-vps2-method2, deploy-vps1-method2]
    if: ${{ github.event.inputs.method == 'method-2' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Update VPS2 with VPS1 wg1 Public Key
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
          VPS1_WG1_KEY: ${{ needs.deploy-vps1-method2.outputs.vps1_wg1_public_key }}
        run: |
          ssh -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "sed -i 's|<VPS1_WG1_PUBLIC_KEY>|$VPS1_WG1_KEY|g' /etc/wireguard/wg1.conf"
          echo "‚úÖ VPS2 updated with VPS1 wg1 public key"

  #=============================================================================
  # RESTART AFTER DEPLOY - Method 2
  #=============================================================================
  restart-after-deploy-method2:
    needs: [load-config, update-vps2-method2]
    if: ${{ github.event.inputs.method == 'method-2' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart WireGuard on VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS2..."
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg-quick down wg1 2>/dev/null || true && wg-quick up wg1"
          echo "‚úÖ VPS2 WireGuard (wg1) restarted"

      - name: Restart WireGuard on VPS1 (wg1 first, then wg0)
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "üîÑ Restarting WireGuard on VPS1..."
          # QUAN TR·ªåNG: Start wg1 TR∆Ø·ªöC (t·∫°o table 51821), sau ƒë√≥ wg0 (t·∫°o ip rule)
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "wg-quick down wg1 2>/dev/null || true && wg-quick down wg0 2>/dev/null || true && wg-quick up wg1 && wg-quick up wg0"
          echo "‚úÖ VPS1 WireGuard (wg1 + wg0) restarted"

  #=============================================================================
  # CHECK STATUS AFTER DEPLOY - Method 2
  #=============================================================================
  check-status-after-deploy-method2:
    needs: [load-config, restart-after-deploy-method2]
    if: ${{ github.event.inputs.method == 'method-2' && github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check VPS1 Status
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS1 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "echo '--- wg0 (Server cho PC) ---' && wg show wg0 && echo '' && echo '--- wg1 (Client ƒë·∫øn VPS2) ---' && wg show wg1 && echo '' && echo '--- Routing Table 51821 ---' && ip route show table 51821"

      - name: Check VPS2 Status
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
        run: |
          echo "================================================"
          echo "  üìä VPS2 WireGuard Status"
          echo "================================================"
          ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg show wg1"

      - name: Test Connectivity VPS1 to VPS2
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
        run: |
          echo "================================================"
          echo "  üîó Testing VPS1 ‚Üí VPS2 Connectivity"
          echo "================================================"
          ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "ping -c 3 10.0.1.1 && echo '‚úÖ VPS1 can reach VPS2 via WireGuard tunnel' || echo '‚ùå VPS1 cannot reach VPS2'"

  #=============================================================================
  # START WIREGUARD (ch·ªâ khi action = start-wireguard)
  #=============================================================================
  start-wireguard:
    needs: load-config
    if: ${{ github.event.inputs.action == 'start-wireguard' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS1_SSH_KEY }}" > ~/.ssh/vps1_key
          echo "${{ secrets.VPS2_SSH_KEY }}" > ~/.ssh/vps2_key
          chmod 600 ~/.ssh/vps1_key ~/.ssh/vps2_key
          ssh-keyscan -p ${{ needs.load-config.outputs.vps1_ssh_port }} ${{ needs.load-config.outputs.vps1_host }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -p ${{ needs.load-config.outputs.vps2_ssh_port }} ${{ needs.load-config.outputs.vps2_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Restart WireGuard on VPS2
        env:
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          VPS2_USER: ${{ needs.load-config.outputs.vps2_user }}
          VPS2_SSH_PORT: ${{ needs.load-config.outputs.vps2_ssh_port }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          if [ "$METHOD" == "method-2" ]; then
            ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg-quick down wg1 2>/dev/null || true && wg-quick up wg1"
            echo "‚úÖ VPS2 WireGuard (wg1) restarted"
          else
            ssh -i ~/.ssh/vps2_key -p $VPS2_SSH_PORT -o StrictHostKeyChecking=no $VPS2_USER@$VPS2_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0"
            echo "‚úÖ VPS2 WireGuard (wg0) restarted"
          fi

      - name: Restart WireGuard on VPS1
        env:
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS1_USER: ${{ needs.load-config.outputs.vps1_user }}
          VPS1_SSH_PORT: ${{ needs.load-config.outputs.vps1_ssh_port }}
          METHOD: ${{ github.event.inputs.method }}
        run: |
          if [ "$METHOD" == "method-2" ]; then
            ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0 && wg-quick down wg1 2>/dev/null || true && wg-quick up wg1"
            echo "‚úÖ VPS1 WireGuard (wg0 + wg1) restarted"
          else
            ssh -i ~/.ssh/vps1_key -p $VPS1_SSH_PORT -o StrictHostKeyChecking=no $VPS1_USER@$VPS1_HOST "wg-quick down wg0 2>/dev/null || true && wg-quick up wg0"
            echo "‚úÖ VPS1 WireGuard restarted"
          fi

  #=============================================================================
  # SUMMARY (sau khi deploy)
  #=============================================================================
  summary:
    needs: [load-config, update-vps1-method1, update-vps2-method2]
    if: ${{ always() && github.event.inputs.action == 'deploy' && (needs.update-vps1-method1.result == 'success' || needs.update-vps2-method2.result == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        env:
          METHOD: ${{ github.event.inputs.method }}
          VPS1_HOST: ${{ needs.load-config.outputs.vps1_host }}
          VPS2_HOST: ${{ needs.load-config.outputs.vps2_host }}
          WG_PORT: ${{ needs.load-config.outputs.wg_port }}
          VPS1_KEY_M1: ${{ needs.deploy-vps1-method1.outputs.vps1_public_key }}
          VPS1_WG0_KEY_M2: ${{ needs.deploy-vps1-method2.outputs.vps1_wg0_public_key }}
        run: |
          echo "================================================================"
          echo "  üìä DEPLOYMENT SUMMARY - $METHOD"
          echo "================================================================"
          
          if [ "$METHOD" == "method-2" ]; then
            VPS1_KEY="$VPS1_WG0_KEY_M2"
            echo "üìç Network Topology:"
            echo "   PC ‚îÄ‚îÄwg0‚îÄ‚îÄ> VPS1 ‚îÄ‚îÄwg1‚îÄ‚îÄ> VPS2 ‚îÄ‚îÄNAT‚îÄ‚îÄ> Internet"
          else
            VPS1_KEY="$VPS1_KEY_M1"
            echo "üìç Network Topology:"
            echo "   PC ‚îÄ‚îÄwg0‚îÄ‚îÄ> VPS1 <‚îÄ‚îÄwg0‚îÄ‚îÄ VPS2 ‚îÄ‚îÄNAT‚îÄ‚îÄ> Internet"
          fi
          
          echo ""
          echo "üìù Config cho PC:"
          echo "================================================================"
          echo "[Interface]"
          echo "Address = 10.0.0.2/24"
          echo "PrivateKey = <PC_PRIVATE_KEY>"
          echo "DNS = 8.8.8.8"
          echo ""
          echo "[Peer]"
          echo "PublicKey = $VPS1_KEY"
          echo "Endpoint = $VPS1_HOST:${WG_PORT:-51820}"
          echo "AllowedIPs = 0.0.0.0/0"
          echo "PersistentKeepalive = 25"
          echo "================================================================"
          echo ""
          if [ "$METHOD" == "method-2" ]; then
            echo "================================================================"
            echo "  ‚úÖ PC PUBLIC KEY ƒê√É ƒê∆Ø·ª¢C T·ª∞ ƒê·ªòNG C·∫§U H√åNH!"
            echo "================================================================"
            echo ""
            echo "PC Public Key t·ª´ config.env ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông thay v√†o VPS1."
            echo "B·∫°n ch·ªâ c·∫ßn b·∫≠t WireGuard tr√™n PC v√† test k·∫øt n·ªëi!"
            echo ""
            echo "üìã TEST K·∫æT N·ªêI:"
            echo "   ping 10.0.0.1     (VPS1)"
            echo "   ping 10.0.1.1     (VPS2)"
            echo "   curl ifconfig.me  (ph·∫£i tr·∫£ v·ªÅ IP c·ªßa VPS2: $VPS2_HOST)"
          else
            echo "üìã B∆∞·ªõc ti·∫øp theo:"
            echo "  1. Copy config tr√™n v√†o WireGuard PC"
            echo "  2. L∆∞u PC public key"
            echo "  3. SSH v√†o VPS1 th√™m PC key:"
            echo "     sed -i 's|<PC_PUBLIC_KEY>|YOUR_KEY|g' /etc/wireguard/wg0.conf"
            echo "     wg-quick down wg0 && wg-quick up wg0"
          fi
          echo ""
