#===============================================================================
# VPS2 WireGuard Server Configuration (Method 2)
# File: /etc/wireguard/wg1.conf
# Nhận kết nối từ VPS1 và NAT ra Internet
#===============================================================================

[Interface]
# IP của VPS2 trong WireGuard network (tunnel 2)
Address = 10.0.1.1/24

# Private key của VPS2 (sẽ được tự động thay thế bởi setup.sh)
PrivateKey = YC9cU17bobHpCx1UtivVwXF484qSdKtr1iSPwMFFLXA=

# Port lắng nghe - dùng 51821 để phân biệt với tunnel 1
ListenPort = 51821

# ===== IP Forward & NAT Rules =====
# Bật IP Forward
PostUp = sysctl -w net.ipv4.ip_forward=1

# NAT traffic từ cả 2 subnet: 10.0.0.0/24 (PC) và 10.0.1.0/24 (VPS1-VPS2)
PostUp = iptables -t nat -A POSTROUTING -s 10.0.0.0/16 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostUp = iptables -A FORWARD -i wg1 -j ACCEPT
PostUp = iptables -A FORWARD -o wg1 -j ACCEPT

PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/16 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostDown = iptables -D FORWARD -i wg1 -j ACCEPT
PostDown = iptables -D FORWARD -o wg1 -j ACCEPT

#===============================================================================
# PEER: VPS1 (wg1 interface)
#===============================================================================
[Peer]
# Public key của wg1 trên VPS1 (thay thế sau khi tạo key trên VPS1)
PublicKey = Qpg1sPk8Dh5dHs5cKyY25AejK059LLdWuR6GhZxMPTQ=

# Cho phép traffic từ VPS1 và từ PC (qua VPS1)
# 10.0.1.2 = IP của VPS1 trong tunnel 2
# 10.0.0.0/24 = Subnet của PC (được route qua VPS1)
AllowedIPs = 10.0.1.2/32, 10.0.0.0/24

# Giữ kết nối (không bắt buộc vì VPS1 sẽ khởi tạo kết nối)
# PersistentKeepalive = 25