#!/bin/bash
#===============================================================================
# VPS1 Setup Script - WireGuard Server (Method 1 - Single Tunnel)
# Ch·ª©c nƒÉng: WG Server nh·∫≠n k·∫øt n·ªëi t·ª´ PC v√† VPS2, forward traffic gi·ªØa ch√∫ng
# Script t·ª± ƒë·ªông t·∫°o wg0.conf v·ªõi keys ƒë√£ ƒëi·ªÅn s·∫µn
#===============================================================================

set -e

echo "================================================"
echo "  VPS1 WireGuard Server Setup (Method 1)"
echo "================================================"

# Ki·ªÉm tra root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå Vui l√≤ng ch·∫°y script v·ªõi quy·ªÅn root (sudo)"
    exit 1
fi

echo ""
echo "[1/4] C√†i ƒë·∫∑t WireGuard..."
apt update
apt install -y wireguard wireguard-tools iptables

echo ""
echo "[2/4] T·∫°o key pair..."
cd /etc/wireguard

if [ ! -f "vps1_privatekey" ]; then
    wg genkey | tee vps1_privatekey | wg pubkey > vps1_publickey
    chmod 600 vps1_privatekey
    echo "    ‚úÖ Keys ƒë√£ ƒë∆∞·ª£c t·∫°o"
else
    echo "    ‚ö†Ô∏è  Keys ƒë√£ t·ªìn t·∫°i, s·ª≠ d·ª•ng keys hi·ªán c√≥..."
fi

VPS1_PRIVATE_KEY=$(cat /etc/wireguard/vps1_privatekey)
VPS1_PUBLIC_KEY=$(cat /etc/wireguard/vps1_publickey)

echo ""
echo "[3/4] T·∫°o file wg0.conf..."

# T·∫°o wg0.conf v·ªõi private key ƒë√£ ƒëi·ªÅn s·∫µn
cat > /etc/wireguard/wg0.conf << EOF
#===============================================================================
# VPS1 WireGuard Server Configuration (Method 1 - Single Tunnel)
# Auto-generated by setup.sh
#===============================================================================

[Interface]
Address = 10.0.0.1/24
PrivateKey = ${VPS1_PRIVATE_KEY}
ListenPort = 51820

# IP Forward Rules
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i wg0 -o wg0 -j ACCEPT
PostDown = iptables -D FORWARD -i wg0 -o wg0 -j ACCEPT

#===============================================================================
# PEER: PC Client
#===============================================================================
[Peer]
# TODO: Thay b·∫±ng public key c·ªßa PC
PublicKey = <PC_PUBLIC_KEY>
AllowedIPs = 10.0.0.2/32

#===============================================================================
# PEER: VPS2 Client (Gateway ra Internet)
#===============================================================================
[Peer]
# TODO: Thay b·∫±ng public key c·ªßa VPS2
PublicKey = <VPS2_PUBLIC_KEY>
AllowedIPs = 10.0.0.3/32, 0.0.0.0/0
EOF

chmod 600 /etc/wireguard/wg0.conf
echo "    ‚úÖ wg0.conf ƒë√£ ƒë∆∞·ª£c t·∫°o"

echo ""
echo "[4/4] Ho√†n t·∫•t (WireGuard ch∆∞a ƒë∆∞·ª£c b·∫≠t)..."

echo ""
echo "================================================"
echo "  ‚úÖ VPS1 Setup ho√†n t·∫•t!"
echo "================================================"
echo ""
echo "üîë VPS1 PUBLIC KEY:"
echo "================================================"
echo "$VPS1_PUBLIC_KEY"
echo "================================================"
echo ""
echo "üìù C√°c b∆∞·ªõc ti·∫øp theo:"
echo "  1. Ch·ªù VPS2 setup xong ƒë·ªÉ l·∫•y VPS2 public key"
echo "  2. Thay <VPS2_PUBLIC_KEY> trong /etc/wireguard/wg0.conf"
echo "  3. Thay <PC_PUBLIC_KEY> trong /etc/wireguard/wg0.conf"
echo "  4. B·∫≠t WireGuard: wg-quick up wg0"
echo ""
