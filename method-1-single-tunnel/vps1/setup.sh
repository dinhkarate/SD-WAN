#!/bin/bash
#===============================================================================
# VPS1 Setup Script - WireGuard Server (Method 1 - Single Tunnel)
# Chá»©c nÄƒng: WG Server nháº­n káº¿t ná»‘i tá»« PC vÃ  VPS2, forward traffic giá»¯a chÃºng
# Script tá»± Ä‘á»™ng táº¡o wg0.conf vá»›i keys Ä‘Ã£ Ä‘iá»n sáºµn
#
# Sá»¬ Dá»¤NG TABLE RIÃŠNG:
# - Traffic tá»« PC â†’ table 51820 â†’ VPS2 â†’ Internet
# - Traffic VPS1 (SSH) â†’ table main â†’ Internet trá»±c tiáº¿p
# Tá»± Ä‘á»™ng táº¡o PC key vÃ  pc-config.conf
#===============================================================================

set -e

echo "================================================"
echo "  VPS1 WireGuard Server Setup (Method 1)"
echo "  ðŸ”’ Vá»›i Policy Routing (khÃ´ng máº¥t káº¿t ná»‘i VPS1)"
echo "================================================"

# Kiá»ƒm tra root
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Vui lÃ²ng cháº¡y script vá»›i quyá»n root (sudo)"
    exit 1
fi

# Load config.env Ä‘á»ƒ láº¥y VPS1_HOST
VPS1_PUBLIC_IP=""
if [ -f "/root/sd-wan/config.env" ]; then
    source /root/sd-wan/config.env
    VPS1_PUBLIC_IP="$VPS1_HOST"
fi

# Náº¿u khÃ´ng cÃ³ trong config.env, láº¥y IP public tá»± Ä‘á»™ng
if [ -z "$VPS1_PUBLIC_IP" ]; then
    VPS1_PUBLIC_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || echo "VPS1_PUBLIC_IP")
fi

echo ""
echo "[1/5] CÃ i Ä‘áº·t WireGuard..."
apt update
apt install -y wireguard wireguard-tools iptables iproute2

echo ""
echo "[2/5] Táº¡o key pairs (VPS1 + PC)..."
cd /etc/wireguard

# Táº¡o VPS1 keys
if [ ! -f "vps1_privatekey" ]; then
    wg genkey | tee vps1_privatekey | wg pubkey > vps1_publickey
    chmod 600 vps1_privatekey
    echo "    âœ… VPS1 keys Ä‘Ã£ Ä‘Æ°á»£c táº¡o"
else
    echo "    âš ï¸  VPS1 keys Ä‘Ã£ tá»“n táº¡i, sá»­ dá»¥ng keys hiá»‡n cÃ³..."
fi

# Táº¡o PC keys
if [ ! -f "pc_privatekey" ]; then
    wg genkey | tee pc_privatekey | wg pubkey > pc_publickey
    chmod 600 pc_privatekey
    echo "    âœ… PC keys Ä‘Ã£ Ä‘Æ°á»£c táº¡o"
else
    echo "    âš ï¸  PC keys Ä‘Ã£ tá»“n táº¡i, sá»­ dá»¥ng keys hiá»‡n cÃ³..."
fi

VPS1_PRIVATE_KEY=$(cat /etc/wireguard/vps1_privatekey)
VPS1_PUBLIC_KEY=$(cat /etc/wireguard/vps1_publickey)
PC_PRIVATE_KEY=$(cat /etc/wireguard/pc_privatekey)
PC_PUBLIC_KEY=$(cat /etc/wireguard/pc_publickey)

echo ""
echo "[3/5] Táº¡o file wg0.conf..."

# Táº¡o wg0.conf vá»›i Table routing Ä‘á»ƒ trÃ¡nh máº¥t káº¿t ná»‘i VPS1
cat > /etc/wireguard/wg0.conf << EOF
#===============================================================================
# VPS1 WireGuard Server Configuration (Method 1 - Single Tunnel)
# Auto-generated by setup.sh
#
# Sá»¬ Dá»¤NG TABLE RIÃŠNG Äá»‚ TRÃNH Máº¤T Káº¾T Ná»I VPS1:
# - Traffic tá»« PC (10.0.0.2) â†’ dÃ¹ng table 51820 â†’ Ä‘i qua VPS2 â†’ Internet
# - Traffic cá»§a VPS1 (SSH, updates) â†’ dÃ¹ng table main â†’ trá»±c tiáº¿p Internet
#===============================================================================

[Interface]
Address = 10.0.0.1/24
PrivateKey = ${VPS1_PRIVATE_KEY}
ListenPort = 51820

# ===== ROUTING TABLE RIÃŠNG =====
# WireGuard sáº½ táº¡o route trong table 51820 thay vÃ¬ table main
# Äiá»u nÃ y Ä‘áº£m báº£o VPS1 khÃ´ng bá»‹ máº¥t káº¿t ná»‘i SSH khi cÃ³ AllowedIPs = 0.0.0.0/0
Table = 51820

# ===== IP Forward Rules =====
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -A FORWARD -i wg0 -o wg0 -j ACCEPT

# ===== POLICY ROUTING =====
# CHá»ˆ traffic Ä‘áº¿n tá»« PC (10.0.0.2) má»›i dÃ¹ng table 51820 â†’ Ä‘i qua VPS2
PostUp = ip rule add from 10.0.0.2 lookup 51820 priority 100

PostDown = iptables -D FORWARD -i wg0 -o wg0 -j ACCEPT
PostDown = ip rule del from 10.0.0.2 lookup 51820 priority 100

#===============================================================================
# PEER: PC Client
#===============================================================================
[Peer]
PublicKey = ${PC_PUBLIC_KEY}
AllowedIPs = 10.0.0.2/32

#===============================================================================
# PEER: VPS2 Client (Gateway ra Internet)
#===============================================================================
[Peer]
# TODO: Sáº½ Ä‘Æ°á»£c workflow tá»± Ä‘á»™ng thay tháº¿
PublicKey = <VPS2_PUBLIC_KEY>
# Route 0.0.0.0/0 sáº½ Ä‘Æ°á»£c táº¡o trong table 51820 (khÃ´ng áº£nh hÆ°á»Ÿng VPS1)
AllowedIPs = 10.0.0.3/32, 0.0.0.0/0
EOF

chmod 600 /etc/wireguard/wg0.conf
echo "    âœ… wg0.conf Ä‘Ã£ Ä‘Æ°á»£c táº¡o (Ä‘Ã£ cÃ³ PC public key)"

echo ""
echo "[4/5] Táº¡o file PC config..."

# Táº¡o pc-config.conf hoÃ n chá»‰nh
mkdir -p /root/sd-wan
cat > /root/sd-wan/pc-config.conf << EOF
#===============================================================================
# PC WireGuard Client Configuration
# Auto-generated - Import trá»±c tiáº¿p vÃ o WireGuard Windows
#===============================================================================

[Interface]
Address = 10.0.0.2/24
PrivateKey = ${PC_PRIVATE_KEY}
DNS = 8.8.8.8, 8.8.4.4

[Peer]
PublicKey = ${VPS1_PUBLIC_KEY}
Endpoint = ${VPS1_PUBLIC_IP}:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

chmod 600 /root/sd-wan/pc-config.conf
echo "    âœ… pc-config.conf Ä‘Ã£ Ä‘Æ°á»£c táº¡o"

echo ""
echo "[5/5] HoÃ n táº¥t (WireGuard chÆ°a Ä‘Æ°á»£c báº­t)..."

echo ""
echo "================================================"
echo "  âœ… VPS1 Setup hoÃ n táº¥t!"
echo "================================================"
echo ""
echo "ðŸ”‘ VPS1 PUBLIC KEY:"
echo "================================================"
echo "$VPS1_PUBLIC_KEY"
echo "================================================"
echo ""
echo "ðŸ“± PC CONFIG (copy hoáº·c download file /root/sd-wan/pc-config.conf):"
echo "================================================"
cat /root/sd-wan/pc-config.conf
echo "================================================"
echo ""
echo "ðŸ“ CÃ¡c bÆ°á»›c tiáº¿p theo:"
echo "  1. Download PC config: scp root@${VPS1_PUBLIC_IP}:/root/sd-wan/pc-config.conf ."
echo "  2. Import vÃ o WireGuard Windows"
echo "  3. Chá» workflow update VPS2 public key"
echo "  4. Báº­t WireGuard trÃªn cáº£ 2 VPS: wg-quick up wg0"
echo ""
echo "ðŸ“Œ LÆ¯U Ã Vá»€ TABLE ROUTING:"
echo "  - Table 51820 Ä‘Æ°á»£c dÃ¹ng riÃªng cho traffic tá»« PC"
echo "  - VPS1 váº«n dÃ¹ng table main â†’ khÃ´ng máº¥t SSH"
echo "  - Kiá»ƒm tra route: ip route show table 51820"
echo "  - Kiá»ƒm tra rule: ip rule show"
echo ""
