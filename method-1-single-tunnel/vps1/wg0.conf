#===============================================================================
# VPS1 WireGuard Server Configuration (Method 1 - Single Tunnel)
# File: /etc/wireguard/wg0.conf
# VPS1 là WG Server nhận từ PC và VPS2, forward traffic giữa chúng
#
# SỬ DỤNG TABLE RIÊNG ĐỂ TRÁNH MẤT KẾT NỐI VPS1:
# - Traffic từ PC (10.0.0.2) → dùng table 51820 → đi qua VPS2 → Internet
# - Traffic của VPS1 (SSH, updates) → dùng table main → trực tiếp Internet
#===============================================================================

[Interface]
# IP của VPS1 trong WireGuard network
Address = 10.0.0.1/24

# Private key của VPS1
PrivateKey = SHCc1pgZIujiEM/3LLVqPiiTLQnWJHBVp1xtK5csI2s=

# Port lắng nghe
ListenPort = 51820

# ===== ROUTING TABLE RIÊNG =====
# WireGuard sẽ tạo route trong table 51820 thay vì table main
# Điều này đảm bảo VPS1 không bị mất kết nối SSH khi có AllowedIPs = 0.0.0.0/0
Table = 51820

# ===== IP Forward Rules =====
# Bật IP Forward
PostUp = sysctl -w net.ipv4.ip_forward=1

# Forward traffic giữa các peers trong wg0
PostUp = iptables -A FORWARD -i wg0 -o wg0 -j ACCEPT

# ===== POLICY ROUTING =====
# CHỈ traffic đến từ PC (10.0.0.2) mới dùng table 51820 → đi qua VPS2
# Traffic của VPS1 vẫn dùng table main → đi trực tiếp ra Internet
PostUp = ip rule add from 10.0.0.2 lookup 51820 priority 100

PostDown = iptables -D FORWARD -i wg0 -o wg0 -j ACCEPT
PostDown = ip rule del from 10.0.0.2 lookup 51820 priority 100

#===============================================================================
# PEER: PC Client
#===============================================================================
[Peer]
# Public key của PC
PublicKey = fTMcYeD5fDXgt/CSPPAvB+JPQGMwhLU2odOG/2Cj1XA=

# IP được phép của PC trong tunnel
AllowedIPs = 10.0.0.2/32

#===============================================================================
# PEER: VPS2 Client (Gateway ra Internet)
#===============================================================================
[Peer]
# Public key của VPS2
PublicKey = mx50MzQmfSUIGeuETgQfmAmT5uDxeGCbnu59VU8rkGQ=

# IP được phép của VPS2 + tất cả traffic Internet sẽ được route qua VPS2
# Route 0.0.0.0/0 sẽ được tạo trong table 51820 (không ảnh hưởng VPS1)
AllowedIPs = 10.0.0.3/32, 0.0.0.0/0

# VPS2 sẽ kết nối đến VPS1 nên không cần Endpoint ở đây
