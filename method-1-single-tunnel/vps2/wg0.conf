#===============================================================================
# VPS2 WireGuard Server Configuration (Method 1)
# File: /etc/wireguard/wg0.conf
#===============================================================================

[Interface]
# IP của VPS2 trong WireGuard network
Address = 10.0.0.1/24

# Private key của VPS2 (sẽ được tự động thay thế bởi setup.sh)
PrivateKey = <VPS2_PRIVATE_KEY>

# Port lắng nghe
ListenPort = 51820

# DNS server cho clients (tùy chọn)
# DNS = 8.8.8.8, 8.8.4.4

# ===== IP Forward & NAT Rules =====
# Khi interface up: bật IP forward và thêm NAT rule để forward traffic ra internet
# Khi interface down: xóa NAT rule

# Bật IP Forward
PostUp = sysctl -w net.ipv4.ip_forward=1

# Xác định interface mạng chính tự động và thêm NAT
PostUp = iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -A FORWARD -o wg0 -j ACCEPT

PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -o wg0 -j ACCEPT

#===============================================================================
# PEER: PC Client
#===============================================================================
[Peer]
# Public key của PC (thay thế sau khi tạo key trên PC)
PublicKey = <PC_PUBLIC_KEY>

# IP được phép của PC trong tunnel
AllowedIPs = 10.0.0.2/32

# Giữ kết nối (hữu ích khi PC đằng sau NAT)
# PersistentKeepalive = 25
