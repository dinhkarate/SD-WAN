#===============================================================================
# VPS2 WireGuard Client Configuration (Method 1 - Single Tunnel)
# File: /etc/wireguard/wg0.conf
# VPS2 là WG Client kết nối đến VPS1, nhận traffic từ PC và NAT ra Internet
#===============================================================================

[Interface]
# IP của VPS2 trong WireGuard network
Address = 10.0.0.3/24

# Private key của VPS2 (sẽ được tự động thay thế bởi setup.sh)
PrivateKey = <VPS2_PRIVATE_KEY>

# Không cần ListenPort vì đây là client kết nối đến VPS1

# ===== IP Forward & NAT Rules =====
# Bật IP Forward
PostUp = sysctl -w net.ipv4.ip_forward=1

# NAT: Traffic từ WireGuard network (10.0.0.0/24) ra Internet
PostUp = iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -A FORWARD -o wg0 -j ACCEPT

PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o $(ip route | grep default | awk '{print $5}' | head -1) -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -o wg0 -j ACCEPT

#===============================================================================
# PEER: VPS1 Server
#===============================================================================
[Peer]
# Public key của VPS1 (thay thế sau khi chạy setup trên VPS1)
PublicKey = <VPS1_PUBLIC_KEY>

# Endpoint: IP public của VPS1
Endpoint = VPS1_PUBLIC_IP:51820

# Cho phép tất cả traffic từ VPS1 (bao gồm traffic từ PC)
AllowedIPs = 10.0.0.0/24

# Giữ kết nối sống (quan trọng vì VPS2 là client)
PersistentKeepalive = 25
