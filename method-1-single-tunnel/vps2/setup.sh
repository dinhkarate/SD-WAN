#!/bin/bash
#===============================================================================
# VPS2 Setup Script - WireGuard Client + NAT (Method 1 - Single Tunnel)
# Ch·ª©c nƒÉng: WG Client k·∫øt n·ªëi ƒë·∫øn VPS1, NAT traffic ra Internet
# Script t·ª± ƒë·ªông t·∫°o wg0.conf v·ªõi keys ƒë√£ ƒëi·ªÅn s·∫µn
#===============================================================================

set -e

# ===== C·∫§U H√åNH =====
VPS1_PUBLIC_IP=""
VPS1_PUBLIC_KEY=""

# Load config.env n·∫øu c√≥
if [ -f "/root/sd-wan/config.env" ]; then
    source /root/sd-wan/config.env
    VPS1_PUBLIC_IP="$VPS1_HOST"
fi

# Nh·∫≠n VPS1_PUBLIC_KEY t·ª´ argument n·∫øu c√≥
if [ -n "$1" ]; then
    VPS1_PUBLIC_KEY="$1"
fi

echo "================================================"
echo "  VPS2 WireGuard Client Setup (Method 1)"
echo "================================================"

# Ki·ªÉm tra root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå Vui l√≤ng ch·∫°y script v·ªõi quy·ªÅn root (sudo)"
    exit 1
fi

# Ki·ªÉm tra VPS1 IP
if [ -z "$VPS1_PUBLIC_IP" ]; then
    echo "‚ùå Thi·∫øu VPS1_PUBLIC_IP! Cung c·∫•p qua config.env ho·∫∑c bi·∫øn m√¥i tr∆∞·ªùng"
    exit 1
fi

echo "    üìç VPS1 IP: $VPS1_PUBLIC_IP"
if [ -n "$VPS1_PUBLIC_KEY" ]; then
    echo "    üîë VPS1 Public Key: ${VPS1_PUBLIC_KEY:0:20}..."
fi

echo ""
echo "[1/4] C√†i ƒë·∫∑t WireGuard..."
apt update
apt install -y wireguard wireguard-tools iptables

echo ""
echo "[2/4] T·∫°o key pair..."
cd /etc/wireguard

if [ ! -f "vps2_privatekey" ]; then
    wg genkey | tee vps2_privatekey | wg pubkey > vps2_publickey
    chmod 600 vps2_privatekey
    echo "    ‚úÖ Keys ƒë√£ ƒë∆∞·ª£c t·∫°o"
else
    echo "    ‚ö†Ô∏è  Keys ƒë√£ t·ªìn t·∫°i, s·ª≠ d·ª•ng keys hi·ªán c√≥..."
fi

VPS2_PRIVATE_KEY=$(cat /etc/wireguard/vps2_privatekey)
VPS2_PUBLIC_KEY=$(cat /etc/wireguard/vps2_publickey)

echo ""
echo "[3/4] T·∫°o file wg0.conf..."

# X√°c ƒë·ªãnh main interface
MAIN_INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1)

# N·∫øu c√≥ VPS1_PUBLIC_KEY th√¨ d√πng, kh√¥ng th√¨ ƒë·ªÉ placeholder
if [ -z "$VPS1_PUBLIC_KEY" ]; then
    VPS1_PUBLIC_KEY="<VPS1_PUBLIC_KEY>"
fi

# T·∫°o wg0.conf
cat > /etc/wireguard/wg0.conf << EOF
#===============================================================================
# VPS2 WireGuard Client Configuration (Method 1 - Single Tunnel)
# Auto-generated by setup.sh
#===============================================================================

[Interface]
Address = 10.0.0.3/24
PrivateKey = ${VPS2_PRIVATE_KEY}

# NAT Rules - Forward traffic ra Internet
PostUp = sysctl -w net.ipv4.ip_forward=1
PostUp = iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o ${MAIN_INTERFACE} -j MASQUERADE
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostUp = iptables -A FORWARD -o wg0 -j ACCEPT

PostDown = iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -o ${MAIN_INTERFACE} -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -o wg0 -j ACCEPT

#===============================================================================
# PEER: VPS1 Server
#===============================================================================
[Peer]
PublicKey = ${VPS1_PUBLIC_KEY}
Endpoint = ${VPS1_PUBLIC_IP}:51820
AllowedIPs = 10.0.0.0/24
PersistentKeepalive = 25
EOF

chmod 600 /etc/wireguard/wg0.conf
echo "    ‚úÖ wg0.conf ƒë√£ ƒë∆∞·ª£c t·∫°o"

echo ""
echo "[4/4] Ho√†n t·∫•t (WireGuard ch∆∞a ƒë∆∞·ª£c b·∫≠t)..."

echo ""
echo "================================================"
echo "  ‚úÖ VPS2 Setup ho√†n t·∫•t!"
echo "================================================"
echo ""
echo "üîë VPS2 PUBLIC KEY:"
echo "================================================"
echo "$VPS2_PUBLIC_KEY"
echo "================================================"
echo ""
echo "üìù C√°c b∆∞·ªõc ti·∫øp theo:"
echo "  1. Copy VPS2 public key ·ªü tr√™n"
echo "  2. Thay <VPS2_PUBLIC_KEY> trong /etc/wireguard/wg0.conf c·ªßa VPS1"
if [ "$VPS1_PUBLIC_KEY" == "<VPS1_PUBLIC_KEY>" ]; then
    echo "  3. Thay <VPS1_PUBLIC_KEY> trong /etc/wireguard/wg0.conf (file n√†y)"
fi
echo "  4. B·∫≠t WireGuard tr√™n c·∫£ 2 VPS: wg-quick up wg0"
echo ""
